name: Criação de Repositório MuleSoft automatizado

on:
  issues:
    types: [opened, reopened]

jobs:
  add-comment:
    name: Add initial comment on issue
    #runs-on: itau-linux
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.issue.labels.*.name, 'MuleSoft') }}
    steps:
      - name: Create comment
        uses: peter-evans/create-or-update-comment@v1
        with: 
          issue-number: ${{ github.event.issue.number }}
          body: |
            Acompanhe o setup através do link: https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}
          reactions: '+1'  

  form-to-json:
    name: Convert Form Issue to JSON
    #runs-on: itau-linux
    runs-on: ubuntu-latest
    needs: [add-comment]
    outputs:
      payload-parsed: ${{ steps.set-payload.outputs.json_var }}
    steps:
      - name: Run issue form parser
        id: parse
        uses: peter-murray/issue-forms-body-parser@v2.0.0
        with:
          issue_id: ${{ github.event.issue.number }} 
          separator: '###'
          label_marker_start: '>>'
          label_marker_end: '<<'

      - name: Set output
        id: set-payload
        run: echo ::set-output name=json_var::'${{ steps.parse.outputs.payload }}'

      - name: Show output
        id: show-payload
        run: echo "${{ steps.set-payload.outputs.json_var.'Tipo de aplicação' }}"
        


  validate-member:
    #uses: itau-corp/itau-up2-reusable-workflows-setup-iupipes/.github/workflow/validate-member.yml@v1
    runs-on: ubuntu-latest
    needs: form-to-json
    outputs:
      payload-parsed: ${{ steps.payload.outputs.json_var }}
    steps:
      - name: Set validate output
        id: payload
        run: echo ::set-output name=json_var::'${{ fromJson(needs.form-to-json.outputs.payload-parsed) }}'
      - name: Show validate output
        run: echo "${{ (steps.payload.outputs.json_var) }}"

#  create-github-repo:
#    uses: itau-corp/itau-up2-reusable-workflows-setup-iupipes/.github/workflow/create-repo.yml@v1
#    needs:
#      - form-to-json
#      - validate-member
#    with:
#      payload: ${{ needs.form-to-json.outputs.payload-parsed }}

  final-comment:
    name: Add final comment on Issue
    #needs: [create-github-repo]
#    runs-on: itau-linux
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.issue.labels.*.name, 'MuleSoft') }}
    steps:
      - name: Create comment
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            Sucesso na criação do repositório. Repositório criado: https://github.com/itau-corp/${{needs.create-github-repo.outputs.repo_name}}
          reactions: '+1'

  auto-closing-issue:
    name: Auto-closing Issue
#    runs-on: itau-linuxx
    runs-on: ubuntu-latest
    needs: [final-comment]
    steps:
      - name: Close Issue
        id: parse
        uses: peter-evans/close-issue@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: Fechando issue automaticamente
